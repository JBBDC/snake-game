<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Title</title>
    <style>
        .cell {
            display: block;
            height: 20px;
            width: 20px;
        }
        #field {
            border: 1px solid black;
            margin-bottom: 10px;
            margin-top: 10px;
        }

        #field, .main {
            display: flex;
            flex-direction: row;
            align-items: center;
        }

        .main {
            flex-direction: column;
        }

        #start-btn {
            font-family: "Droid Sans Mono", sans-serif;
            padding: 20px 50px;
        }
        #score, #start-btn {
            font-size: 1.1rem;
            color: green;
            font-family: "DejaVu Sans Mono", sans-serif;
        }
    </style>
</head>
<body>
<div class="main">
    <h1>It's a SNAKE!</h1>
    <div><span>Score: </span><span id="score">300</span></div>
    <div id="field"></div>
    <button id="start-btn">Старт!</button>
</div>
</body>
<script>
    const size = 15;
    const fieldDiv = document.getElementById("field");
    const initialSpeed = 300;
    const acceleration = 10;
    const winLimit = 30;
    window.speed = initialSpeed;
    window.direction = "up";

    window.apple = {};
    window.snake = [];
    window.head = {};
    window.tail = {};
    window.isDirectionPicked = false;


    function setButtonListeners() {
        document.addEventListener('keydown', function (event) {
            if (!isDirectionPicked) {
                switch (event.key) {
                    case "ArrowLeft":
                        if (direction !== "right" && direction !== "left") {
                            window.direction = "left";
                            window.isDirectionPicked = true;
                        }
                        break;
                    case "ArrowRight":
                        if (direction !== "right" && direction !== "left") {
                            window.direction = "right";
                            window.isDirectionPicked = true;
                        }
                        break;
                    case "ArrowUp":
                        if (direction !== "up" && direction !== "down") {
                            window.direction = "up";
                            window.isDirectionPicked = true;
                        }
                        break;
                    case "ArrowDown":
                        if (direction !== "up" && direction !== "down") {
                            window.direction = "down";
                            window.isDirectionPicked = true;
                        }
                }
            }
        });

        document.getElementById("start-btn").addEventListener('click', function () {
            let btn = document.getElementById("start-btn");
            if(btn.classList.contains("running")) {
                btn.classList.remove("running");
                stopGame();
                btn.innerText = "Старт!"
            } else {
                btn.classList.add("running");
                startGame();
                btn.innerText = "Стоп!"
            }
        })
    }

    function spawnApple() {
        let randomCoordinates = {y: getRandomInt(size), x: getRandomInt(size)};
        while (contains(randomCoordinates.x, randomCoordinates.y, window.snake)) {
            randomCoordinates = {y: getRandomInt(size), x: getRandomInt(size)};
        }
        window.apple = randomCoordinates;
    }

    function spawnSnake() {
        window.snake = [
            {y: Math.floor(size / 2), x: Math.floor(size / 2)},
            {y: Math.floor(size / 2), x: Math.floor(size / 2) + 1},
            {y: Math.floor(size / 2), x: Math.floor(size / 2) + 2}
        ];
        window.head = window.snake[0];
        window.tail = window.snake[window.snake.length - 1];
    }

    function draw() {
        clearCanvas();
        for (let y = 0; y < size; y++) {
            let row = document.createElement("div");
            row.setAttribute("id", "newRow");
            fieldDiv.append(row);
            for (let x = 0; x < size; x++) {
                if (contains(x, y, getSnakeBody())) {
                    appendNewCell(row, `<span style="color: darkgreen;">X</span>`);
                } else if (head.x === x && head.y === y) {
                    appendNewCell(row, `<span style="color: forestgreen;">Q</span>`);
                } else if (window.apple.x === x && window.apple.y === y) {
                    appendNewCell(row, `<span style="color: red;">O</span>`);
                } else {
                    appendNewCell(row, "&nbsp;");
                }
            }
            row.removeAttribute("id");
        }
    }

    function clearCanvas() {
        while (fieldDiv.firstChild) {
            fieldDiv.removeChild(fieldDiv.lastChild);
        }
    }

    function contains(x, y, coordinatesArray) {
        for (let coordinates of coordinatesArray) {
            if (coordinates.x === x && coordinates.y === y) {
                return true;
            }
        }
        return false;
    }

    function appendNewCell(container, spanValue) {
        let newCell = document.createElement("span");
        newCell.innerHTML = spanValue;
        newCell.classList.add("cell");
        container.append(newCell);
    }

    function getRandomInt(max) {
        return Math.floor(Math.random() * Math.floor(max));
    }

    function addHead() {
        switch (window.direction) {
            case "up":
                window.snake.unshift({y: window.head.y, x: window.head.x - 1});
                break;
            case "down":
                window.snake.unshift({y: window.head.y, x: window.head.x + 1});
                break;
            case "right":
                window.snake.unshift({y: window.head.y + 1, x: window.head.x});
                break;
            case "left":
                window.snake.unshift({y: window.head.y - 1, x: window.head.x});
        }
        window.head = window.snake[0];
    }

    function removeTail() {
        window.snake.pop();
        window.tail = window.snake[window.snake.length - 1];
    }

    function move() {
        addHead();
        if(isAppleEaten()) {
            spawnApple();
            speedUp();
            refreshScore();
        } else {
            removeTail();
        }
        window.isDirectionPicked = false;
    }

    function speedUp() {
        window.speed -= acceleration;
        clearInterval(game);
        window.game = setInterval(step, speed);
    }

    function getSnakeBody() {
        let snakeBody = window.snake.slice(0);
        snakeBody.shift();
        return snakeBody;
    }

    function isGameOver() {
        return contains(window.head.x, window.head.y, getSnakeBody()) || window.head.x < 0
            || window.head.y < 0 || window.head.x > size - 1 || window.head.y > size - 1;
    }

    function startGame() {
        window.speed = initialSpeed;
        window.direction = "up";
        spawnApple();
        spawnSnake();
        window.game = setInterval(step, speed);
    }

    function stopGame() {
        window.speed = initialSpeed;
        clearInterval(game);
        window.direction = "up";
        spawnApple();
        spawnSnake();
        document.getElementById("start-btn").classList.remove("running");
        document.getElementById("start-btn").innerText = "Старт!";
    }

    function refreshScore() {
        let score = document.getElementById("score");
        score.innerText = String(snake.length*100);
    }

    function isAppleEaten() {
        if(head.x === apple.x && head.y === apple.y) {
            return true;
        }
        return false;
    }

    function step() {
        move();
        if (isGameOver()) {
            alert("Game Over!");
            stopGame();
        } else if (window.snake.length >= winLimit) {
            alert("You Won!")
            stopGame();
        } else {
            draw();
        }
    }

    /* -- START -- */

    setButtonListeners();
    draw();

</script>
</html>